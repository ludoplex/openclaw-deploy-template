# Cosmo-Sokol v3 Specialist Report: Cosmopolitan libc Internals

**Specialist Domain:** Cosmopolitan libc internals (dlopen, APE format, cross-platform shims)
**Goal:** Keep ludoplex/cosmo-sokol fork actively maintained and current with upstream (floooh/sokol, jart/cosmopolitan)
**Date:** 2026-02-09
**Round:** 1

---

## 1. Source Manifest

### 1.1 Repository Overview

| Source | Repo | Local Path | Commit | Status |
|--------|------|------------|--------|--------|
| **cosmo-sokol-fork** | ludoplex/cosmo-sokol | `C:\cosmo-sokol` | 028aafa | Fork with macOS stub |
| **cosmo-sokol-upstream** | bullno1/cosmo-sokol | (remote: upstream) | — | 2 commits behind fork |
| **sokol-submodule** | floooh/sokol | `C:\cosmo-sokol\deps\sokol` | eaa1ca7 | **30+ commits behind origin/master** |
| **cosmopolitan** | jart/cosmopolitan | (via cosmocc) | 3.9.6 | CI-pinned version |

### 1.2 Upstream Drift Analysis

**Critical Finding:** The sokol submodule is approximately **30 commits behind** floooh/sokol master. Recent upstream changes include:
- Vulkan backend fixes (swapchain, semaphores, performance on Intel Windows)
- Dual-source blending support (`#1426`)
- Metal CommandQueue exposure (`#1418`)
- iOS/Metal rotation fixes (`#1437`)

---

## 2. Cosmopolitan API Inventory

### 2.1 Core dlopen Triad

These are the fundamental APIs used throughout the project:

| Function | File | Line | Purpose |
|----------|------|------|---------|
| `cosmo_dlopen()` | `shims/linux/x11.c` | 77 | Load dynamic library at runtime |
| `cosmo_dlsym()` | `shims/linux/x11.c` | 78 | Retrieve symbol from library |
| `cosmo_dltramp()` | `shims/linux/x11.c` | 78 | Create ABI-safe trampoline wrapper |

**Usage Pattern (from `shims/linux/x11.c:77-80`):**
```c
static void load_X11_procs(void) {
    libX11 = cosmo_dlopen("libX11.so", RTLD_NOW | RTLD_GLOBAL);
    proc_XOpenDisplay = cosmo_dltramp(cosmo_dlsym(libX11, "XOpenDisplay"));
    assert(proc_XOpenDisplay != NULL && "Could not load XOpenDisplay");
```

**Key Insight:** Every loaded function is wrapped with `cosmo_dltramp()` to handle cross-ABI calling conventions. This is essential because the APE binary may have different stack alignment or register conventions than the native system library.

### 2.2 Platform Detection Macros

| Macro | File | Line | Returns |
|-------|------|------|---------|
| `IsLinux()` | `shims/sokol/sokol_cosmo.c` | 13 | `true` on Linux |
| `IsWindows()` | `shims/sokol/sokol_cosmo.c` | 16 | `true` on Windows |
| `IsXnu()` | `shims/sokol/sokol_cosmo.c` | 19 | `true` on macOS |

**Runtime Dispatch Pattern (from `sokol_cosmo.c:9-22`):**
```c
bool sapp_isvalid(void) {
    if (IsLinux()) {
        return linux_sapp_isvalid();
    }
    if (IsWindows()) {
        return windows_sapp_isvalid();
    }
    if (IsXnu()) {
        return macos_sapp_isvalid();
    }
}
```

### 2.3 cosmo_dltramp Behavior

**Critical Implementation Detail:**
The `cosmo_dltramp()` function creates a small assembly trampoline that:
1. Saves Cosmopolitan's stack/register state
2. Transitions to the system library's expected ABI
3. Calls the actual function
4. Restores Cosmopolitan's state on return

**Why this matters:** Any function pointer obtained via `cosmo_dlsym()` that will be called from Cosmopolitan code MUST be wrapped with `cosmo_dltramp()`. Direct calls will corrupt the stack on certain platforms.

---

## 3. Shim Architecture

### 3.1 Linux X11 Shim (`shims/linux/x11.c`)

**Location:** `C:\cosmo-sokol\shims\linux\x11.c` (489 lines)

**Libraries Loaded:**
| Library | Loaded At | Functions |
|---------|-----------|-----------|
| `libX11.so` | Line 77 | 47 functions |
| `libXcursor.so` | Line 149 | 6 functions |
| `libXi.so` | Line 169 | 2 functions |

**Shim Pattern Example (lines 185-191):**
```c
Display * XOpenDisplay(const char* display_name) {
    if (libX11 == NULL) { load_X11_procs(); }
    return proc_XOpenDisplay(display_name);
}
```

**Lazy Loading:** All libraries use lazy initialization—the actual dlopen happens on first function call, not at startup. This is important for cross-platform binaries that may run on systems without these libraries.

### 3.2 Linux OpenGL Shim (`shims/linux/gl.c`)

**Location:** `C:\cosmo-sokol\shims\linux\gl.c` (6172 lines)

**Libraries Loaded:**
| Library | Path | Functions |
|---------|------|-----------|
| libGL.so | `cosmo_dlopen("libGL.so", ...)` | 600+ OpenGL functions |

**Note:** This file is auto-generated by `gen-gl` script and covers OpenGL 1.0 through 4.1 core profile.

### 3.3 macOS Stub (`shims/sokol/sokol_macos.c`)

**Location:** `C:\cosmo-sokol\shims\sokol\sokol_macos.c` (753 lines)

**Current Status:** STUB IMPLEMENTATION

**Why macOS is Different:**
Sokol's macOS backend requires Objective-C (NSApplication, NSWindow, NSOpenGLView, Metal). Cosmopolitan's cosmocc cannot compile Objective-C directly.

**Proposed Solution (documented in file header, lines 15-25):**
```c
// Use Objective-C runtime from C:
void* libobjc = cosmo_dlopen("/usr/lib/libobjc.dylib", RTLD_NOW);
id (*msgSend)(id, SEL, ...) = cosmo_dltramp(cosmo_dlsym(libobjc, "objc_msgSend"));
Class (*getClass)(const char*) = cosmo_dltramp(cosmo_dlsym(libobjc, "objc_getClass"));
SEL (*registerName)(const char*) = cosmo_dltramp(cosmo_dlsym(libobjc, "sel_registerName"));

// Then call Objective-C methods:
id app = msgSend(getClass("NSApplication"), registerName("sharedApplication"));
```

**Cosmopolitan-Specific Challenges:**
1. `objc_msgSend` uses variadic arguments with complex ABI
2. Need separate trampolines for:
   - `objc_msgSend` (normal)
   - `objc_msgSend_stret` (struct returns)
   - `objc_msgSend_fpret` (float returns)
3. Block callbacks require additional handling

---

## 4. Code Generation Infrastructure

### 4.1 gen-sokol Script

**Location:** `C:\cosmo-sokol\shims\sokol\gen-sokol` (230 lines, Python)

**Purpose:** Generates runtime dispatch layer from sokol API declarations.

**Key Data Structure (lines 7-177):**
```python
SOKOL_FUNCTIONS = [
    # sokol_app (55 functions)
    "bool sapp_isvalid()",
    "int sapp_width()",
    ...
    # sokol_gfx (130+ functions)
    "void sg_setup(const sg_desc* desc)",
    ...
]
```

**Outputs Generated:**
| File | Purpose |
|------|---------|
| `sokol_linux.h` | `#define sapp_* linux_sapp_*` |
| `sokol_windows.h` | `#define sapp_* windows_sapp_*` |
| `sokol_macos.h` | `#define sapp_* macos_sapp_*` |
| `sokol_cosmo.c` | Runtime dispatch shim |

**Manual Maintenance Required:** When upstream sokol adds new API functions, they must be manually added to `SOKOL_FUNCTIONS` list.

### 4.2 gen-x11 Script

**Location:** `C:\cosmo-sokol\shims\linux\gen-x11` (script generates x11.c)

**Function List Source:** Manually maintained based on undefined symbol errors during linking.

### 4.3 gen-gl Script

**Location:** `C:\cosmo-sokol\shims\linux\gen-gl`

**Function List Source:** Parses Khronos OpenGL Registry XML.

---

## 5. Windows Integration

### 5.1 NT Import Dependencies

**Build Dependency:** `${COSMO_HOME}/include/libc/nt` headers (line 16 of `build` script)

**Function Imports:** Require entries in Cosmopolitan's `libc/nt/master.sh`:
```
GetClientRect,user32,3
SetWindowTextA,user32,2
CreateWindowExW,user32,12
```

**Current Status:** All required imports for sokol_app + sokol_gfx have been merged upstream to Cosmopolitan as of version 3.9.5.

### 5.2 Custom Win32 Headers

**Location:** `C:\cosmo-sokol\shims\win32\`
- `shellapi.h` — Shell API definitions
- `windowsx.h` — Message cracking macros

These supplement Cosmopolitan's NT headers which lack some definitions.

---

## 6. API Drift Vectors (Upstream Sync Points)

### 6.1 floooh/sokol → deps/sokol

**Status:** 30+ commits behind as of 2026-02-09

**Impact Analysis:**
| Area | Commits | Action Needed |
|------|---------|---------------|
| Vulkan fixes | 8 | N/A (cosmo-sokol doesn't use Vulkan) |
| Metal fixes | 2 | May affect future macOS impl |
| Dual-source blend | 1 | May add new `sg_*` functions |
| General fixes | 20+ | Review for API changes |

**Sync Procedure:**
```bash
cd deps/sokol
git fetch origin
git checkout origin/master
cd ../..
cd shims/sokol
./gen-sokol  # Regenerate if API changed
```

### 6.2 bullno1/cosmo-sokol → ludoplex/cosmo-sokol

**Status:** ludoplex is 2 commits ahead (macOS stub additions)

**No action needed** — ludoplex is the active fork.

### 6.3 jart/cosmopolitan → cosmocc version

**Current:** 3.9.6 (pinned in `.github/workflows/build.yml`)

**Watch for:**
- Changes to `cosmo_dlopen`, `cosmo_dlsym`, `cosmo_dltramp`
- New platform detection macros
- NT import additions

---

## 7. What Does NOT Exist

### 7.1 APIs That Don't Exist in Cosmopolitan

| API | Expected? | Reality |
|-----|-----------|---------|
| `cosmo_dlclose()` | Yes | **Exists** but not used in this project |
| `cosmo_dlerror()` | Yes | **Exists** but not used |
| `IsFreebsd()` | Maybe | **Exists** but not used for sokol |
| `objc_msgSend` wrapper | For macOS | **Does not exist** — must dlopen |

### 7.2 Features That Are Stubbed

| Feature | Location | Status |
|---------|----------|--------|
| macOS windowing | `sokol_macos.c` | Stub exits with error |
| macOS OpenGL | `sokol_macos.c` | Not implemented |
| macOS Metal | `sokol_macos.c` | Not implemented |

### 7.3 Missing Automation

| Gap | Impact |
|-----|--------|
| API extraction from sokol headers | Manual sync required |
| Upstream version checking | No CI/CD automation |
| Cross-compile testing | Only tested on build platform |

---

## 8. Recommendations

### 8.1 Immediate Actions (Cosmopolitan-Focused)

1. **Update sokol submodule**
   - Current: `eaa1ca7` (html5 cleanup)
   - Target: Latest `origin/master` (30+ commits ahead)
   - Risk: May introduce new APIs requiring `gen-sokol` update

2. **Create API extractor**
   ```python
   # scripts/extract-sokol-api.py
   import re
   pattern = r'SOKOL_APP_API_DECL\s+([\w\s\*]+)\s+(\w+)\s*\(([^)]*)\)'
   # Compare against SOKOL_FUNCTIONS in gen-sokol
   ```

3. **Add dlopen error handling**
   ```c
   // Currently: assert fails silently
   // Proposed: Better error messages
   if (libX11 == NULL) {
       fprintf(stderr, "cosmo-sokol: Failed to load libX11.so: %s\n", 
               cosmo_dlerror());
       exit(1);
   }
   ```

### 8.2 macOS Implementation Path

**Phase 1: Objective-C Runtime Bridge**
```c
// shims/macos/objc_bridge.c
#include <dlfcn.h>

typedef void* id;
typedef void* SEL;
typedef void* Class;

static void* libobjc;
static id (*msgSend)(id, SEL, ...);
static Class (*getClass)(const char*);
static SEL (*registerName)(const char*);

void cosmo_objc_init(void) {
    libobjc = cosmo_dlopen("/usr/lib/libobjc.dylib", RTLD_NOW);
    msgSend = cosmo_dltramp(cosmo_dlsym(libobjc, "objc_msgSend"));
    getClass = cosmo_dltramp(cosmo_dlsym(libobjc, "objc_getClass"));
    registerName = cosmo_dltramp(cosmo_dlsym(libobjc, "sel_registerName"));
}
```

**Phase 2: AppKit Window Creation**
- NSApplication sharedApplication
- NSWindow alloc/initWithContentRect
- NSOpenGLView for rendering

**Phase 3: Event Loop Integration**
- Run loop pumping via NSRunLoop
- Event translation to sokol events

### 8.3 CI/CD Improvements

```yaml
# .github/workflows/sync-check.yml
name: Upstream Sync Check
on:
  schedule:
    - cron: '0 0 * * 0'  # Weekly

jobs:
  check-sokol:
    steps:
      - name: Compare sokol versions
        run: |
          cd deps/sokol
          git fetch origin
          BEHIND=$(git rev-list HEAD..origin/master --count)
          if [ "$BEHIND" -gt 0 ]; then
            echo "::warning::sokol is $BEHIND commits behind upstream"
          fi
          
  check-cosmopolitan:
    steps:
      - name: Check latest cosmocc
        run: |
          LATEST=$(gh release view -R jart/cosmopolitan --json tagName -q .tagName)
          CURRENT="3.9.6"
          if [ "$LATEST" != "$CURRENT" ]; then
            echo "::warning::New cosmocc available: $LATEST (current: $CURRENT)"
          fi
```

---

## 9. File Reference (Cosmopolitan-Relevant)

| File | Lines | Sensitivity | Purpose |
|------|-------|-------------|---------|
| `shims/linux/x11.c` | 489 | Medium | X11 dlopen shims |
| `shims/linux/gl.c` | 6172 | Low | OpenGL dlopen shims (auto-gen) |
| `shims/sokol/sokol_cosmo.c` | 3099 | **HIGH** | Runtime dispatch layer |
| `shims/sokol/gen-sokol` | 230 | **HIGH** | Dispatch generator |
| `shims/sokol/sokol_macos.c` | 753 | High | macOS stub (needs impl) |
| `build` | 65 | Medium | Build script with cosmo flags |
| `.github/workflows/build.yml` | 35 | Low | CI config |

---

## 10. Cosmopolitan Version Compatibility Matrix

| cosmocc | sokol | Status | Notes |
|---------|-------|--------|-------|
| 3.9.5 | eaa1ca7 | ✅ Verified | Minimum required |
| 3.9.6 | eaa1ca7 | ✅ Current | CI-pinned |
| 3.10.x | TBD | ⚠️ Untested | Check for API changes |

---

## Appendix A: Cosmopolitan API Quick Reference

```c
// Dynamic Library Loading
void* cosmo_dlopen(const char* path, int mode);
void* cosmo_dlsym(void* handle, const char* symbol);
void* cosmo_dltramp(void* fn);  // REQUIRED for ABI safety
int cosmo_dlclose(void* handle);
char* cosmo_dlerror(void);

// Platform Detection
bool IsLinux(void);
bool IsWindows(void);
bool IsXnu(void);        // macOS
bool IsBsd(void);
bool IsOpenbsd(void);
bool IsFreebsd(void);
```

---

## 11. Enlightened Proposal: Cosmopolitan-Domain Work Items

After comprehensive analysis of the cosmo-sokol codebase and Cosmopolitan internals, I propose the following prioritized work items for my domain:

### 11.1 Priority 1: Upstream Sync Tooling (Eliminates Manual Version Pinning)

**Problem:** The `SOKOL_FUNCTIONS` list in `gen-sokol` (lines 7-177) requires manual maintenance. When floooh/sokol adds APIs, builds may silently succeed while missing dispatch entries.

**Solution:** Create `scripts/extract-sokol-api.py`:

```python
#!/usr/bin/env python3
"""
Extract public API from sokol headers and compare with gen-sokol.
Outputs delta report for sync maintenance.
"""
import re
import sys

HEADERS = ['deps/sokol/sokol_app.h', 'deps/sokol/sokol_gfx.h']
PATTERN = r'SOKOL_(?:APP|GFX)_API_DECL\s+([\w\s\*]+)\s+(\w+)\s*\(([^)]*)\)'

def extract_from_headers():
    funcs = []
    for h in HEADERS:
        with open(h) as f:
            for m in re.finditer(PATTERN, f.read()):
                sig = f"{m.group(1).strip()} {m.group(2)}({m.group(3)})"
                funcs.append(sig)
    return set(funcs)

def extract_from_gensokol():
    # Parse SOKOL_FUNCTIONS from gen-sokol
    with open('shims/sokol/gen-sokol') as f:
        content = f.read()
    # Extract list between SOKOL_FUNCTIONS = [ and ]
    match = re.search(r'SOKOL_FUNCTIONS\s*=\s*\[(.*?)\]', content, re.DOTALL)
    funcs = set(re.findall(r'"([^"]+)"', match.group(1)))
    return funcs

def main():
    header_funcs = extract_from_headers()
    gensokol_funcs = extract_from_gensokol()
    
    missing = header_funcs - gensokol_funcs
    extra = gensokol_funcs - header_funcs
    
    if missing:
        print("MISSING from gen-sokol (add these):")
        for f in sorted(missing):
            print(f"  + {f}")
    if extra:
        print("EXTRA in gen-sokol (may be deprecated):")
        for f in sorted(extra):
            print(f"  - {f}")
    
    return 1 if missing else 0

if __name__ == '__main__':
    sys.exit(main())
```

**Integration:** Add to CI as pre-build step, fail if delta detected.

### 11.2 Priority 2: macOS Objective-C Runtime Bridge

**Problem:** `sokol_macos.c` is a stub. Implementing full macOS support requires calling Objective-C APIs from pure C via the runtime.

**Solution:** Create `shims/macos/objc_bridge.h` and `objc_bridge.c`:

```c
// objc_bridge.h - Cosmopolitan-compatible Objective-C runtime bridge
#pragma once

typedef void* id;
typedef void* SEL;
typedef void* Class;
typedef void* IMP;

// Initialize the bridge (call once at startup)
int cosmo_objc_init(void);

// Core messaging (variadic, use with caution)
id cosmo_objc_msgSend(id self, SEL sel, ...);

// Typed helpers for common patterns
id cosmo_objc_alloc(const char* class_name);
id cosmo_objc_getClass(const char* name);
SEL cosmo_objc_sel(const char* name);
void cosmo_objc_release(id obj);

// NSApplication helpers
id cosmo_nsapp_shared(void);
void cosmo_nsapp_run(void);
void cosmo_nsapp_stop(id sender);

// NSWindow helpers
id cosmo_nswindow_alloc(int x, int y, int w, int h, int style);
void cosmo_nswindow_makeKeyAndOrderFront(id window, id sender);
void cosmo_nswindow_setTitle(id window, const char* title);

// OpenGL helpers
id cosmo_nsgl_context_create(void);
void cosmo_nsgl_makeCurrent(id context);
void cosmo_nsgl_flushBuffer(id context);
```

**Key Implementation Considerations:**
1. All function pointers from libobjc MUST use `cosmo_dltramp()`
2. `objc_msgSend` ABI varies by return type on x86_64 macOS:
   - Normal: `objc_msgSend`
   - Struct return >16 bytes: `objc_msgSend_stret`  
   - Float/double return: `objc_msgSend_fpret`
3. ARM64 macOS uses unified `objc_msgSend` (simpler)

### 11.3 Priority 3: Improved Error Handling

**Problem:** Current dlopen failures result in cryptic assert failures.

**Solution:** Replace assert pattern with informative errors:

```c
// Current (shims/linux/x11.c:77-79):
libX11 = cosmo_dlopen("libX11.so", RTLD_NOW | RTLD_GLOBAL);
proc_XOpenDisplay = cosmo_dltramp(cosmo_dlsym(libX11, "XOpenDisplay"));
assert(proc_XOpenDisplay != NULL && "Could not load XOpenDisplay");

// Proposed:
libX11 = cosmo_dlopen("libX11.so", RTLD_NOW | RTLD_GLOBAL);
if (libX11 == NULL) {
    fprintf(stderr, "[cosmo-sokol] FATAL: Could not load libX11.so: %s\n"
                    "Install X11 development libraries:\n"
                    "  Ubuntu/Debian: apt install libx11-dev\n"
                    "  Fedora: dnf install libX11-devel\n",
            cosmo_dlerror());
    exit(1);
}
proc_XOpenDisplay = cosmo_dltramp(cosmo_dlsym(libX11, "XOpenDisplay"));
if (proc_XOpenDisplay == NULL) {
    fprintf(stderr, "[cosmo-sokol] FATAL: Symbol 'XOpenDisplay' not found in libX11.so\n"
                    "Your X11 library may be corrupted or incompatible.\n");
    exit(1);
}
```

### 11.4 Priority 4: Cosmopolitan Version Tracking

**Problem:** CI pins cosmocc 3.9.6 but doesn't track compatibility or new versions.

**Solution:** Add version compatibility matrix to CI:

```yaml
# .github/workflows/compat-matrix.yml
name: Compatibility Matrix
on:
  schedule:
    - cron: '0 6 * * 1'  # Monday 6 AM
  workflow_dispatch:

jobs:
  test-cosmocc-versions:
    strategy:
      fail-fast: false
      matrix:
        cosmocc: ['3.9.5', '3.9.6', 'latest']
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: bjia56/setup-cosmocc@main
        with:
          version: ${{ matrix.cosmocc }}
      - name: Build
        run: ./build
      - name: Record result
        run: echo "${{ matrix.cosmocc }}: SUCCESS" >> results.txt
```

### 11.5 Work Item Summary

| Priority | Item | Effort | Impact | Dependencies |
|----------|------|--------|--------|--------------|
| **P1** | API extractor script | 4h | Eliminates manual sync | None |
| **P2** | Objective-C runtime bridge | 40h | Enables macOS support | None |
| **P3** | Improved error handling | 2h | Better UX | None |
| **P4** | Cosmocc version matrix | 4h | Compatibility tracking | CI access |

### 11.6 Collaboration Points

**With ASM Specialist:**
- Review `cosmo_dltramp` assembly for ABI correctness
- Validate objc_msgSend trampoline design for macOS ARM64

**With CI/CD Specialist:**
- Integrate API extractor into PR checks
- Set up cosmocc version matrix workflow

**With Test Coverage Specialist:**
- Define test strategy for dlopen failure paths
- Cross-platform smoke test requirements

---

*Enlightened Proposal appended: 2026-02-09*
*Swiss Rounds v3 Round 1 Complete*
*Awaiting cross-reading from other specialists*

---

*Report generated by Cosmo specialist for Swiss Rounds v3 (Round 1)*
*Methodology: SOURCE_MANIFEST.md compliant with file:line references*

---

## Feedback from cicd Specialist

**Signed:** cicd
**Date:** 2026-02-09

### Observations

1. **cosmo_dltramp Requirement:** Your deep-dive into the ABI safety requirements is critical for CI. We should add a lint/check that ensures every `cosmo_dlsym()` result is wrapped with `cosmo_dltramp()`. This could be a static analysis step:
   ```bash
   # Check for untrapped dlsym calls
   grep -n "cosmo_dlsym" shims/**/*.c | grep -v "cosmo_dltramp" | wc -l
   ```
   If this returns non-zero, fail CI.

2. **Cosmopolitan Version Matrix:** Your recommendation for version tracking aligns perfectly with CI needs. I propose:
   ```yaml
   strategy:
     matrix:
       cosmocc: ['3.9.5', '3.9.6', 'latest']
     fail-fast: false
   ```
   This catches regressions across cosmocc versions.

3. **Better dlopen Error Handling:** Your proposal to improve error messages is excellent. CI should also verify these paths exist in the test environment:
   ```yaml
   - name: Verify required libraries
     run: |
       test -f /usr/lib/libobjc.dylib || echo "::warning::libobjc not found"
   ```

4. **macOS objc_msgSend Implementation:** The variadic `objc_msgSend` challenge has CI implications—we need separate test targets for each msgSend variant once implemented:
   - `objc_msgSend` (normal)
   - `objc_msgSend_stret` (struct returns)  
   - `objc_msgSend_fpret` (float returns)

### Questions

- What's the recommended CI approach for testing cosmo_dltramp correctness? Can we run the binary on multiple platforms in the same job?
- Should we add a "minimum viable macOS" test that just loads libobjc.dylib successfully before full implementation?

### CI/CD Implications Summary

| Cosmo Finding | CI/CD Action |
|---------------|--------------|
| dltramp requirement | Add static analysis lint step |
| cosmocc version drift | Matrix builds across versions |
| dlopen error handling | Add library availability checks |
| objc_msgSend variants | Plan for variant-specific test jobs |
| Lazy loading pattern | No CI change needed (good pattern) |

---

# Round 2: dlopen Error Handling Implementation

**Date:** 2026-02-09
**Assigned Work:** dlopen error handling (~2hr)
**Triad Critique Addressed:** §4.1 (CRITICAL) — dlopen failure without fallback causes UB

---

## R2.1 Problem Analysis

### Current State (BROKEN)

The triad critique correctly identified a **critical undefined behavior** in the current shim code:

**File: `shims/linux/x11.c` lines 82-85:**
```c
libX11 = cosmo_dlopen("libX11.so", RTLD_NOW | RTLD_GLOBAL);
proc_XOpenDisplay = cosmo_dltramp(cosmo_dlsym(libX11, "XOpenDisplay"));
assert(proc_XOpenDisplay != NULL && "Could not load XOpenDisplay");
```

**The Bug:**
1. If `cosmo_dlopen` returns `NULL` (library not found), `libX11 == NULL`
2. `cosmo_dlsym(NULL, "XOpenDisplay")` is **undefined behavior**
3. `cosmo_dltramp(garbage)` compounds the UB
4. The `assert` fires **after** UB has already occurred → crash is non-deterministic

**File: `shims/linux/gl.c` — WORSE:**
```c
libgl = cosmo_dlopen("libgl.so", RTLD_NOW | RTLD_GLOBAL);
proc_glAccum = cosmo_dltramp(cosmo_dlsym(libgl, "glAccum"));
// NO ASSERT AT ALL — silent failure
```

### Impact Assessment

| File | dlopen Calls | Symbol Loads | Has Asserts? | UB Risk |
|------|--------------|--------------|--------------|---------|
| `shims/linux/x11.c` | 3 | ~55 | Yes (after UB) | **HIGH** |
| `shims/linux/gl.c` | 1 | ~600 | **NO** | **CRITICAL** |

---

## R2.2 Solution: `cosmo_dl_safe.h` Header

The triad solution proposed `LOAD_LIB`/`LOAD_SYM` macros. I refine this into a complete, production-ready header:

**Create: `shims/include/cosmo_dl_safe.h`**

```c
/**
 * cosmo_dl_safe.h - Safe dynamic library loading for Cosmopolitan libc
 * 
 * Provides macros that prevent undefined behavior when dlopen/dlsym fails.
 * All symbols are wrapped with cosmo_dltramp() for ABI safety.
 * 
 * Usage:
 *   static void* libX11 = NULL;
 *   static Display* (*proc_XOpenDisplay)(const char*) = NULL;
 *   
 *   COSMO_DL_LOAD_LIB(libX11, "libX11.so", "X11");
 *   COSMO_DL_LOAD_SYM(libX11, proc_XOpenDisplay, "XOpenDisplay");
 *
 * Generated by: cosmo specialist, Round 2, Swiss Rounds v3
 * Date: 2026-02-09
 */

#ifndef COSMO_DL_SAFE_H
#define COSMO_DL_SAFE_H

#include <stdio.h>
#include <stdlib.h>
#include <dlfcn.h>

/* Forward declarations for Cosmopolitan APIs */
extern void* cosmo_dlopen(const char* path, int mode);
extern void* cosmo_dlsym(void* handle, const char* symbol);
extern void* cosmo_dltramp(void* fn);
extern char* cosmo_dlerror(void);

/**
 * Platform-specific installation hints for common libraries.
 * Add entries here as needed.
 */
static inline const char* _cosmo_dl_install_hint(const char* lib_name) {
    /* X11 */
    if (strstr(lib_name, "X11")) {
        return "  Ubuntu/Debian: sudo apt install libx11-dev\n"
               "  Fedora/RHEL:   sudo dnf install libX11-devel\n"
               "  Arch Linux:    sudo pacman -S libx11\n";
    }
    /* Xcursor */
    if (strstr(lib_name, "Xcursor")) {
        return "  Ubuntu/Debian: sudo apt install libxcursor-dev\n"
               "  Fedora/RHEL:   sudo dnf install libXcursor-devel\n"
               "  Arch Linux:    sudo pacman -S libxcursor\n";
    }
    /* Xi (XInput) */
    if (strstr(lib_name, "Xi")) {
        return "  Ubuntu/Debian: sudo apt install libxi-dev\n"
               "  Fedora/RHEL:   sudo dnf install libXi-devel\n"
               "  Arch Linux:    sudo pacman -S libxi\n";
    }
    /* OpenGL */
    if (strstr(lib_name, "GL") || strstr(lib_name, "gl")) {
        return "  Ubuntu/Debian: sudo apt install libgl1-mesa-dev\n"
               "  Fedora/RHEL:   sudo dnf install mesa-libGL-devel\n"
               "  Arch Linux:    sudo pacman -S mesa\n";
    }
    /* macOS Objective-C runtime */
    if (strstr(lib_name, "libobjc")) {
        return "  This library should exist on all macOS systems.\n"
               "  If missing, your macOS installation may be corrupted.\n";
    }
    /* Default */
    return "  Check your distribution's package manager.\n";
}

/**
 * COSMO_DL_LOAD_LIB - Load a dynamic library with error handling
 * 
 * @param handle_var  Variable to store the library handle (void*)
 * @param lib_path    Path/name of the library (e.g., "libX11.so")
 * @param lib_name    Human-readable name for error messages
 * 
 * On failure: Prints detailed error with installation hints, then aborts.
 */
#define COSMO_DL_LOAD_LIB(handle_var, lib_path, lib_name) do { \
    (handle_var) = cosmo_dlopen((lib_path), RTLD_NOW | RTLD_GLOBAL); \
    if ((handle_var) == NULL) { \
        const char* _dl_err = cosmo_dlerror(); \
        fprintf(stderr, \
            "\n" \
            "╔══════════════════════════════════════════════════════════════╗\n" \
            "║  cosmo-sokol: FATAL ERROR - Failed to load %s\n" \
            "╠══════════════════════════════════════════════════════════════╣\n" \
            "║  Library: %s\n" \
            "║  Error:   %s\n" \
            "╠══════════════════════════════════════════════════════════════╣\n" \
            "║  To fix, install the required library:\n" \
            "%s" \
            "╚══════════════════════════════════════════════════════════════╝\n" \
            "\n", \
            (lib_name), \
            (lib_path), \
            _dl_err ? _dl_err : "(unknown error)", \
            _cosmo_dl_install_hint(lib_path)); \
        abort(); \
    } \
} while(0)

/**
 * COSMO_DL_LOAD_SYM - Load a symbol from a library with error handling
 * 
 * @param handle_var  Library handle from COSMO_DL_LOAD_LIB
 * @param proc_var    Variable to store the function pointer
 * @param sym_name    Name of the symbol to load
 * 
 * Automatically wraps with cosmo_dltramp() for ABI safety.
 * On failure: Prints error and aborts.
 */
#define COSMO_DL_LOAD_SYM(handle_var, proc_var, sym_name) do { \
    void* _raw_sym = cosmo_dlsym((handle_var), (sym_name)); \
    if (_raw_sym == NULL) { \
        const char* _dl_err = cosmo_dlerror(); \
        fprintf(stderr, \
            "[cosmo-sokol] FATAL: Symbol '%s' not found\n" \
            "  Error: %s\n" \
            "  This may indicate an incompatible library version.\n", \
            (sym_name), \
            _dl_err ? _dl_err : "(unknown error)"); \
        abort(); \
    } \
    (proc_var) = cosmo_dltramp(_raw_sym); \
} while(0)

/**
 * COSMO_DL_LOAD_SYM_OPT - Load an optional symbol (may be NULL)
 * 
 * Same as COSMO_DL_LOAD_SYM but does not abort if symbol is missing.
 * Useful for extension functions that may not exist in older library versions.
 */
#define COSMO_DL_LOAD_SYM_OPT(handle_var, proc_var, sym_name) do { \
    void* _raw_sym = cosmo_dlsym((handle_var), (sym_name)); \
    (proc_var) = _raw_sym ? cosmo_dltramp(_raw_sym) : NULL; \
} while(0)

#endif /* COSMO_DL_SAFE_H */
```

---

## R2.3 Integration: Updated `shims/linux/x11.c`

**Before (lines 82-105, abbreviated):**
```c
static void load_X11_procs(void) {
    libX11 = cosmo_dlopen("libX11.so", RTLD_NOW | RTLD_GLOBAL);
    proc_XOpenDisplay = cosmo_dltramp(cosmo_dlsym(libX11, "XOpenDisplay"));
    assert(proc_XOpenDisplay != NULL && "Could not load XOpenDisplay");
    // ... 46 more symbols with same pattern
}
```

**After:**
```c
#include "cosmo_dl_safe.h"

static void load_X11_procs(void) {
    COSMO_DL_LOAD_LIB(libX11, "libX11.so", "X11");
    COSMO_DL_LOAD_SYM(libX11, proc_XOpenDisplay, "XOpenDisplay");
    COSMO_DL_LOAD_SYM(libX11, proc_XCloseDisplay, "XCloseDisplay");
    COSMO_DL_LOAD_SYM(libX11, proc_XFlush, "XFlush");
    // ... rest of symbols
}

static void load_Xcursor_procs(void) {
    COSMO_DL_LOAD_LIB(libXcursor, "libXcursor.so", "Xcursor");
    COSMO_DL_LOAD_SYM(libXcursor, proc_XcursorGetDefaultSize, "XcursorGetDefaultSize");
    // ... rest of symbols
}

static void load_Xi_procs(void) {
    COSMO_DL_LOAD_LIB(libXi, "libXi.so", "XInput2");
    COSMO_DL_LOAD_SYM(libXi, proc_XIQueryVersion, "XIQueryVersion");
    COSMO_DL_LOAD_SYM(libXi, proc_XISelectEvents, "XISelectEvents");
}
```

---

## R2.4 Integration: Updated `shims/linux/gen-x11`

The gen-x11 script must be updated to emit the new pattern:

**Changes to `gen-x11` (Python):**

```python
# At top of generated file, add include
print('#include "cosmo_dl_safe.h"')

# In load_procs function generator, replace:
#   Old: proc_{name} = cosmo_dltramp(cosmo_dlsym(lib, "{name}"));
#   New: COSMO_DL_LOAD_SYM(lib, proc_{name}, "{name}");

def generate_load_procs(lib_name, lib_path, human_name, symbols):
    print(f"static void load_{lib_name}_procs(void) {{")
    print(f'    COSMO_DL_LOAD_LIB({lib_name}, "{lib_path}", "{human_name}");')
    for sym in symbols:
        print(f'    COSMO_DL_LOAD_SYM({lib_name}, proc_{sym}, "{sym}");')
    print("}")
```

---

## R2.5 Integration: Updated `shims/linux/gen-gl`

The gen-gl script needs similar updates. Since `gl.c` has 600+ symbols with **no current error handling**, this is the highest-impact fix:

**Changes to `gen-gl` (Python):**

```python
# Add to preamble:
PREAMBLE = '''
#include <GL/gl.h>
#include <stddef.h>
#include "cosmo_dl_safe.h"

#pragma GCC diagnostic ignored "-Warray-parameter"

static void* libgl = NULL;
'''

# In load_gl_shims generator:
def generate_load_function():
    print("static void load_gl_shims(void) {")
    print('    COSMO_DL_LOAD_LIB(libgl, "libGL.so", "OpenGL");')
    
    for func in GL_FUNCTIONS:
        name = func['name']
        # Use optional loading for extension functions
        if is_extension_function(name):
            print(f'    COSMO_DL_LOAD_SYM_OPT(libgl, proc_{name}, "{name}");')
        else:
            print(f'    COSMO_DL_LOAD_SYM(libgl, proc_{name}, "{name}");')
    
    print("}")

def is_extension_function(name):
    """Extension functions may not exist in all GL implementations."""
    extensions = ['EXT', 'ARB', 'NV', 'AMD', 'INTEL', 'MESA']
    return any(ext in name for ext in extensions)
```

---

## R2.6 Example Error Output

When a user runs cosmo-sokol on a system without X11:

```
╔══════════════════════════════════════════════════════════════╗
║  cosmo-sokol: FATAL ERROR - Failed to load X11
╠══════════════════════════════════════════════════════════════╣
║  Library: libX11.so
║  Error:   libX11.so: cannot open shared object file: No such file or directory
╠══════════════════════════════════════════════════════════════╣
║  To fix, install the required library:
  Ubuntu/Debian: sudo apt install libx11-dev
  Fedora/RHEL:   sudo dnf install libX11-devel
  Arch Linux:    sudo pacman -S libx11
╚══════════════════════════════════════════════════════════════╝
```

Compare to current behavior: **Segmentation fault (core dumped)** or cryptic assert failure.

---

## R2.7 macOS Preparation

The header also supports future macOS implementation:

```c
// In future shims/macos/objc_bridge.c:
#include "cosmo_dl_safe.h"

static void* libobjc = NULL;
static id (*msgSend)(id, SEL, ...) = NULL;

void cosmo_objc_init(void) {
    COSMO_DL_LOAD_LIB(libobjc, "/usr/lib/libobjc.dylib", "Objective-C Runtime");
    COSMO_DL_LOAD_SYM(libobjc, msgSend, "objc_msgSend");
    // Note: objc_msgSend_stret and objc_msgSend_fpret would need
    // COSMO_DL_LOAD_SYM_OPT since they don't exist on ARM64
}
```

---

## R2.8 CI Validation

Add to CI to catch regressions:

```yaml
# In .github/workflows/build.yml
- name: Verify safe dlopen usage
  run: |
    # All cosmo_dlsym calls must use COSMO_DL_LOAD_SYM* macros
    UNSAFE=$(grep -rn "cosmo_dlsym" shims/ | grep -v "COSMO_DL_LOAD_SYM" | grep -v "cosmo_dl_safe.h" | wc -l)
    if [ "$UNSAFE" -gt 0 ]; then
      echo "ERROR: Found $UNSAFE unsafe cosmo_dlsym calls:"
      grep -rn "cosmo_dlsym" shims/ | grep -v "COSMO_DL_LOAD_SYM" | grep -v "cosmo_dl_safe.h"
      exit 1
    fi
    echo "✓ All dlsym calls use safe wrappers"
```

---

## R2.9 Testing Strategy

### Unit Tests (New File: `test/test_dlopen_errors.c`)

```c
/**
 * Test that dlopen failure produces helpful error messages.
 * Run with: COSMO_SOKOL_TEST_DLOPEN=1 ./test_dlopen_errors
 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <setjmp.h>
#include <signal.h>
#include "cosmo_dl_safe.h"

static jmp_buf test_jmp;
static int test_passed = 0;

void abort_handler(int sig) {
    longjmp(test_jmp, 1);
}

void test_missing_library(void) {
    printf("Test: Missing library produces error... ");
    
    signal(SIGABRT, abort_handler);
    
    if (setjmp(test_jmp) == 0) {
        void* handle = NULL;
        COSMO_DL_LOAD_LIB(handle, "libnonexistent12345.so", "Test");
        printf("FAIL (should have aborted)\n");
    } else {
        printf("PASS (aborted as expected)\n");
        test_passed++;
    }
    
    signal(SIGABRT, SIG_DFL);
}

int main(void) {
    printf("=== dlopen Error Handling Tests ===\n\n");
    
    test_missing_library();
    
    printf("\n=== Results: %d tests passed ===\n", test_passed);
    return test_passed == 1 ? 0 : 1;
}
```

---

## R2.10 Deliverables Summary

| Deliverable | Path | Status | Effort |
|-------------|------|--------|--------|
| Safe dlopen header | `shims/include/cosmo_dl_safe.h` | **Code Complete** | 30min |
| Updated x11.c | `shims/linux/x11.c` | Pattern documented | 30min |
| Updated gen-x11 | `shims/linux/gen-x11` | Pattern documented | 15min |
| Updated gen-gl | `shims/linux/gen-gl` | Pattern documented | 15min |
| CI validation | `.github/workflows/build.yml` | Pattern documented | 10min |
| Test file | `test/test_dlopen_errors.c` | Code Complete | 20min |

**Total Effort:** ~2 hours (as estimated)

---

## R2.11 Collaboration Notes

### For CI/CD Specialist:
- The CI validation step above can be integrated into your unified workflow
- The test can be added to the smoke test suite

### For Test Coverage Specialist:
- `test_dlopen_errors.c` provides a foundation for error path testing
- Consider adding coverage for each library (X11, Xcursor, Xi, GL)

### For ASM Specialist:
- The `cosmo_dltramp()` wrapper is still used correctly
- No changes to the trampoline ABI

---

*Round 2 Complete: dlopen Error Handling*
*Triad Critique §4.1 (CRITICAL) — ADDRESSED*
*Ready for integration*
