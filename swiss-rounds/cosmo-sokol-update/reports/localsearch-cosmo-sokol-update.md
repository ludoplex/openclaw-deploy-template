# Codebase Analysis Tools for cosmo-sokol Upstream Sync

**Agent:** localsearch  
**Date:** 2026-02-09  
**Round:** Swiss Rounds Round 1 — Initial Report

## Executive Summary

This report documents tooling and patterns for extracting API surfaces from Sokol headers and detecting changes between versions. The key discovery is that **Sokol already has a bindgen infrastructure** using Clang AST that we can leverage directly.

---

## 1. API Extraction — Parsing Sokol Headers

### 1.1 Sokol's Native Bindgen (Recommended)

Sokol includes a `bindgen/` directory with Python tools that use Clang's AST dump for API extraction. This is the **authoritative** method.

**Key File:** `floooh/sokol/bindgen/gen_ir.py`

```python
# Core extraction using Clang AST
def clang(csrc_path, with_comments=False):
    cmd = ['clang', '-Xclang', '-ast-dump=json', "-c", csrc_path]
    if with_comments:
        cmd.append('-fparse-all-comments')
    return subprocess.check_output(cmd)
```

**Outputs:** JSON intermediate representation with:
- Struct definitions (`RecordDecl`)
- Enum definitions (`EnumDecl`) 
- Function declarations (`FunctionDecl`)
- Parameter types and names
- Comments/documentation

### 1.2 Usage Pattern

```bash
# Clone sokol repo to access bindgen tools
git clone https://github.com/floooh/sokol.git
cd sokol/bindgen

# Generate IR for a header (requires clang in PATH)
python gen_ir.py ../sokol_gfx.h sokol_gfx sg_ --dep-prefix slog_
```

The output is a `.json` file with all public API declarations.

---

## 2. Grep Patterns for SOKOL_*_API_DECL Functions

### 2.1 API Declaration Macros

Each Sokol header uses a specific API declaration prefix:

| Header | Prefix Macro | Function Prefix |
|--------|--------------|-----------------|
| sokol_gfx.h | `SOKOL_GFX_API_DECL` | `sg_*` |
| sokol_app.h | `SOKOL_APP_API_DECL` | `sapp_*` |
| sokol_audio.h | `SOKOL_AUDIO_API_DECL` | `saudio_*` |
| sokol_glue.h | `SOKOL_GLUE_API_DECL` | `sglue_*` |
| sokol_log.h | `SOKOL_LOG_API_DECL` | `slog_*` |

### 2.2 Grep/Ripgrep Patterns

**Find all public function declarations:**
```bash
# PowerShell/Windows (using Select-String)
Get-Content sokol_gfx.h | Select-String -Pattern "^SOKOL_GFX_API_DECL\s+\w+"

# Unix with grep
grep -E "^SOKOL_(GFX|APP|AUDIO|GLUE|LOG)_API_DECL\s+" sokol_*.h

# Ripgrep (fast, cross-platform)
rg "^SOKOL_\w+_API_DECL\s+(\w+\s+)+\w+\(" sokol_*.h
```

**Extract function signatures:**
```bash
# Match full function declarations (multiline not handled)
rg "SOKOL_\w+_API_DECL\s+\w+\s+\w+\([^)]*\)" --only-matching sokol_gfx.h
```

**Find struct definitions:**
```bash
# Named structs with sg_ prefix
rg "^typedef\s+struct\s+sg_\w+" sokol_gfx.h

# All sg_ prefixed types
rg "^typedef\s+(struct|enum)\s+sg_\w+\s*\{" sokol_gfx.h
```

**Find enum definitions:**
```bash
rg "^typedef\s+enum\s+sg_\w+" sokol_gfx.h
```

### 2.3 PowerShell Pattern for Windows

```powershell
# Extract all function declarations with return types
$pattern = 'SOKOL_GFX_API_DECL\s+(\w+)\s+(\w+)\s*\(([^)]*)\)'
Select-String -Path sokol_gfx.h -Pattern $pattern -AllMatches |
    ForEach-Object { $_.Matches } |
    ForEach-Object { 
        [PSCustomObject]@{
            ReturnType = $_.Groups[1].Value
            FunctionName = $_.Groups[2].Value
            Parameters = $_.Groups[3].Value
        }
    }
```

---

## 3. Diff Tooling — Comparing API Surfaces

### 3.1 JSON-Based API Diff (Using Sokol's Bindgen)

**Script: `api_diff.py`**
```python
#!/usr/bin/env python3
"""Compare two Sokol API JSON files generated by gen_ir.py"""
import json
import sys

def load_api(path):
    with open(path) as f:
        data = json.load(f)
    api = {}
    for decl in data['decls']:
        name = decl.get('name', f"anon_{decl['kind']}")
        api[name] = decl
    return api

def diff_apis(old_path, new_path):
    old = load_api(old_path)
    new = load_api(new_path)
    
    added = set(new.keys()) - set(old.keys())
    removed = set(old.keys()) - set(new.keys())
    common = set(old.keys()) & set(new.keys())
    
    changed = []
    for name in common:
        if old[name] != new[name]:
            changed.append((name, old[name], new[name]))
    
    return {
        'added': sorted(added),
        'removed': sorted(removed),
        'changed': changed
    }

if __name__ == '__main__':
    old_api, new_api = sys.argv[1], sys.argv[2]
    diff = diff_apis(old_api, new_api)
    
    print(f"=== API Changes ===")
    print(f"Added ({len(diff['added'])}): {diff['added']}")
    print(f"Removed ({len(diff['removed'])}): {diff['removed']}")
    print(f"Changed ({len(diff['changed'])}): {[c[0] for c in diff['changed']]}")
```

### 3.2 Git-Based Header Diff

```bash
# Compare headers between two versions
git diff v1.0..v2.0 -- sokol_gfx.h | grep "^[+-]SOKOL_GFX_API_DECL"

# Find all changed function declarations
git diff v1.0..v2.0 -- sokol_gfx.h | grep -E "^[+-].*sg_\w+\("
```

### 3.3 ctags-Based Symbol Extraction

```bash
# Generate tags for old version
ctags --c-kinds=+p -f old.tags sokol_gfx.h.old

# Generate tags for new version  
ctags --c-kinds=+p -f new.tags sokol_gfx.h.new

# Compare symbol lists
diff <(cut -f1 old.tags | sort) <(cut -f1 new.tags | sort)
```

---

## 4. AST Parsing Tools for C Analysis

### 4.1 Clang AST Dump (Primary Method)

This is what Sokol's bindgen uses internally:

```bash
# Full AST dump as JSON
clang -Xclang -ast-dump=json -c sokol_gfx.h > ast.json

# Filtered dump (functions only)
clang -Xclang -ast-dump=json -Xclang -ast-dump-filter=sg_ sokol_gfx.h
```

**Advantages:**
- Accurate parsing (same compiler used to build)
- Handles macros, typedefs, complex types
- JSON output easily processed

### 4.2 ctags/Universal Ctags

```bash
# Install universal-ctags (better than exuberant-ctags)
# Windows: scoop install universal-ctags
# macOS: brew install universal-ctags

# Generate comprehensive tags
ctags --c-kinds=+pxd --extras=+q -R --fields=+S sokol_gfx.h

# Output format for functions:
# sg_make_buffer	sokol_gfx.h	/^SOKOL_GFX_API_DECL sg_buffer sg_make_buffer/
```

### 4.3 cscope Database

```bash
# Build cscope database
cscope -b -q -k sokol_gfx.h

# Query functions called by sg_setup
cscope -d -L2 sg_setup

# Find function definitions
cscope -d -L1 "sg_.*"
```

### 4.4 Python libclang Binding

```python
#!/usr/bin/env python3
"""Extract API using libclang Python bindings"""
from clang.cindex import Index, CursorKind

def extract_functions(header_path):
    index = Index.create()
    tu = index.parse(header_path, args=['-x', 'c'])
    
    functions = []
    for cursor in tu.cursor.walk_preorder():
        if cursor.kind == CursorKind.FUNCTION_DECL:
            if cursor.spelling.startswith('sg_'):
                params = [(p.spelling, p.type.spelling) 
                          for p in cursor.get_arguments()]
                functions.append({
                    'name': cursor.spelling,
                    'return_type': cursor.result_type.spelling,
                    'params': params
                })
    return functions

if __name__ == '__main__':
    import sys, json
    funcs = extract_functions(sys.argv[1])
    print(json.dumps(funcs, indent=2))
```

**Installation:**
```bash
pip install libclang
```

---

## 5. Change Detection Scripts

### 5.1 Complete Sync Workflow Script

```bash
#!/bin/bash
# sync_check.sh - Check for upstream changes

SOKOL_UPSTREAM="https://github.com/floooh/sokol.git"
COSMO_UPSTREAM="https://github.com/jart/cosmopolitan.git"
WORK_DIR="./upstream-check"

# Clone/update upstreams
mkdir -p "$WORK_DIR"
cd "$WORK_DIR"

# Fetch latest Sokol
if [ -d sokol ]; then
    cd sokol && git fetch --all && cd ..
else
    git clone --bare "$SOKOL_UPSTREAM" sokol
fi

# Get commit hashes
CURRENT_SOKOL=$(cat ../SOKOL_VERSION 2>/dev/null || echo "none")
LATEST_SOKOL=$(git -C sokol rev-parse HEAD)

echo "=== Sokol Status ==="
echo "Current: $CURRENT_SOKOL"
echo "Latest:  $LATEST_SOKOL"

if [ "$CURRENT_SOKOL" != "$LATEST_SOKOL" ]; then
    echo "UPDATES AVAILABLE"
    git -C sokol log --oneline "$CURRENT_SOKOL".."$LATEST_SOKOL" -- "*.h"
fi
```

### 5.2 API Surface Change Detector

```python
#!/usr/bin/env python3
"""
api_surface_monitor.py - Detect breaking changes in Sokol API
"""
import subprocess
import json
import hashlib
from pathlib import Path

SOKOL_HEADERS = [
    'sokol_gfx.h',
    'sokol_app.h', 
    'sokol_audio.h',
    'sokol_glue.h',
    'sokol_log.h'
]

def get_api_hash(header_content: str) -> str:
    """Extract and hash public API declarations"""
    import re
    
    # Extract SOKOL_*_API_DECL lines
    api_lines = re.findall(
        r'^SOKOL_\w+_API_DECL\s+.*?;',
        header_content,
        re.MULTILINE
    )
    
    # Extract typedef struct/enum declarations
    type_defs = re.findall(
        r'^typedef\s+(struct|enum)\s+\w+\s*\{[^}]+\}\s*\w+;',
        header_content,
        re.MULTILINE | re.DOTALL
    )
    
    combined = '\n'.join(sorted(api_lines + type_defs))
    return hashlib.sha256(combined.encode()).hexdigest()[:16]

def check_changes(old_dir: Path, new_dir: Path):
    """Compare API surfaces between two versions"""
    changes = []
    
    for header in SOKOL_HEADERS:
        old_path = old_dir / header
        new_path = new_dir / header
        
        if not old_path.exists() or not new_path.exists():
            continue
            
        old_hash = get_api_hash(old_path.read_text())
        new_hash = get_api_hash(new_path.read_text())
        
        if old_hash != new_hash:
            changes.append({
                'header': header,
                'old_hash': old_hash,
                'new_hash': new_hash
            })
    
    return changes

if __name__ == '__main__':
    import sys
    if len(sys.argv) != 3:
        print("Usage: api_surface_monitor.py <old_dir> <new_dir>")
        sys.exit(1)
    
    changes = check_changes(Path(sys.argv[1]), Path(sys.argv[2]))
    if changes:
        print("API CHANGES DETECTED:")
        for c in changes:
            print(f"  {c['header']}: {c['old_hash']} -> {c['new_hash']}")
    else:
        print("No API changes detected")
```

### 5.3 PowerShell Version for Windows

```powershell
# api_check.ps1 - Windows-friendly API change detection

param(
    [string]$OldHeader,
    [string]$NewHeader
)

function Get-ApiSignatures {
    param([string]$Path)
    
    $content = Get-Content $Path -Raw
    $pattern = 'SOKOL_\w+_API_DECL\s+\w+\s+(\w+)\s*\([^)]*\)'
    
    [regex]::Matches($content, $pattern) | ForEach-Object {
        $_.Groups[1].Value
    } | Sort-Object -Unique
}

$old = Get-ApiSignatures $OldHeader
$new = Get-ApiSignatures $NewHeader

$added = Compare-Object $old $new | Where-Object { $_.SideIndicator -eq '=>' }
$removed = Compare-Object $old $new | Where-Object { $_.SideIndicator -eq '<=' }

Write-Host "=== API Changes ===" -ForegroundColor Cyan
Write-Host "Added functions:" -ForegroundColor Green
$added | ForEach-Object { Write-Host "  + $($_.InputObject)" }

Write-Host "Removed functions:" -ForegroundColor Red  
$removed | ForEach-Object { Write-Host "  - $($_.InputObject)" }
```

---

## 6. Recommended Toolchain

### Primary Tools

| Tool | Purpose | Install |
|------|---------|---------|
| **Clang** | AST parsing | `scoop install llvm` / system package |
| **Python 3** | Scripting | Already available |
| **libclang** | Python bindings | `pip install libclang` |
| **Universal Ctags** | Symbol extraction | `scoop install universal-ctags` |
| **Git** | Version comparison | Already available |

### Workflow

1. **Periodic Check**: Run `sync_check.sh` to detect upstream updates
2. **API Extraction**: Use Sokol's `gen_ir.py` for both old and new versions
3. **Diff Analysis**: Compare JSON outputs with `api_diff.py`
4. **Manual Review**: Inspect changed functions/structs for breaking changes
5. **Update Fork**: Apply changes with appropriate Cosmopolitan adaptations

---

## 7. Key Findings

### Sokol API Patterns Discovered

1. **Consistent Naming**: All public functions use `sg_`, `sapp_`, etc. prefixes
2. **API Declaration Macros**: `SOKOL_*_API_DECL` marks all public functions
3. **Header-Only Design**: Implementation guarded by `SOKOL_IMPL`/`SOKOL_*_IMPL`
4. **Bindgen Infrastructure**: Official tools exist at `floooh/sokol/bindgen/`

### Cosmopolitan Integration Points

The Cosmopolitan port likely needs to handle:
- Platform detection macros (`_WIN32`, `__linux__`, etc.)
- Graphics backend selection (`SOKOL_GLCORE`, `SOKOL_D3D11`, etc.)
- System library linking differences

---

## Appendix: Quick Reference

### One-Liner: Extract All Function Names

```bash
grep -oP 'SOKOL_GFX_API_DECL\s+\w+\s+\K\w+(?=\s*\()' sokol_gfx.h
```

### One-Liner: Count API Functions Per Header

```bash
for h in sokol_*.h; do 
    echo "$h: $(grep -c '_API_DECL' $h) functions"
done
```

### One-Liner: Generate API Manifest

```bash
clang -Xclang -ast-dump=json sokol_gfx.h 2>/dev/null | \
    python -c "import json,sys; d=json.load(sys.stdin); \
    print('\n'.join(x['name'] for x in d['inner'] if x.get('name','').startswith('sg_')))"
```
