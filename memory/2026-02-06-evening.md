# 2026-02-06 Evening Session

## Major Accomplishment: MHI Procurement Engine Architecture Rewrite

### The Problem We Solved
We were trying to statically link Sokol with cosmocc — **WRONG**. Cosmopolitan has NO native OpenGL/GPU support.

### The Correct Architecture (llamafile pattern)
1. **APE binaries are PKZIP archives** (not just "ZIP" — PKZIP is the correct term)
2. **Self-extract at runtime**: APE reads from its own PKZIP section via `/zip/...` paths
3. **Dynamic libraries need extraction**: OS loader (dlopen/LoadLibrary) can't read `/zip/`, so extract to real filesystem
4. **Persistent app directory**: Extract to `~/.mhi-procurement/` or `%LOCALAPPDATA%\.mhi-procurement\` — NOT temp!
5. **mtime caching**: Check if cached file is current, skip extraction if unchanged
6. **cosmo_dlopen()**: Load the extracted helper via OS's native dynamic linker

### Key Distinction Vincent Emphasized
- **PKZIP** = the format (Phil Katz's ZIP format, PK magic bytes)
- **ZIP** = colloquial/generic term
- llamafile source literally says "from PKZIP" in comments

### Files Created/Updated
- `skills/sokol-cosmo/SKILL.md` — Complete guide with llamafile pattern
- `C:\mhi-procurement\` — 65 files changed, 70K+ lines added
  - `src/main.c` — APE with cosmo_dlopen(), mtime caching
  - `helpers/gui_{linux,windows,macos}` — Platform implementations
  - `src/gui_interface.h` — Stable C ABI with symbol macros
  - `tests/` — Comprehensive test suite
  - `docs/ARCHITECTURE.md`, `docs/TESTING.md`
  - `.github/workflows/build.yml` — Multi-platform CI

### Agent Coordination
Spawned and coordinated 4 agents for the rewrite:
- **asm** — Designed gui_interface.h (C ABI, function pointers)
- **cicd** — Build system (Makefile, platform scripts, GitHub Actions)
- **testcov** — Test strategy (extraction, caching, dlopen verification)
- **cosmo** — Main architecture + fixing extraction to use app dir

All agents were alerted to the correct PKZIP/self-extract pattern after I initially got it wrong.

## Mighty Boot (Ventoy Fork)

### EFI Signing for Secure Boot
- Need **EV Code Signing Certificate** (~$280-550/yr)
  - Sectigo: cheapest at $279-377/yr with multi-year
  - GlobalSign: $550/yr
  - DigiCert: premium
- Register with **Microsoft Hardware Dev Center**
- Submit .efi binaries in signed CAB file
- Microsoft signs with their UEFI CA
- Requirements: SHA-256, HSM-backed keys (FIPS 140-2 Level 2)

### GUID Change
- Replace `ventoy.net` with `mightyhouseinc.com` in boot sectors
- Breaking backward compatibility is OK

## e9studio Analysis

Reviewed `C:\e9studio\src\e9patch\` source code:
- Supports ELF and PE separately (MODE_ELF_EXE, MODE_PE_EXE, etc.)
- **No explicit APE/PKZIP awareness**
- Issue: When emitting patched binary, may clobber PKZIP data if adding mappings past original size
- Needs: Detect PKZIP trailer (scan for `PK\x05\x06`), preserve when emitting
- Decision: Don't add APE support now to avoid confusing agents further

## tar vs PKZIP Explanation

| tar | PKZIP |
|-----|-------|
| Sequential (tape drives) | Random access (disks) |
| No central directory | Central directory at END |
| Must scan from start | Seek directly by offset |
| Can't append efficiently | Can append, update central dir |

APE uses PKZIP specifically because **central directory at END** allows appending data after executable code.

## Backup Completed
- 16:19 MST — 223.15 MB → Local/OneDrive/Google Drive

## Commits
- `mhi-procurement`: Complete cosmo_dlopen architecture rewrite (65 files, 70K+ lines)
- `workspace`: sokol-cosmo skill with correct PKZIP terminology and llamafile pattern
