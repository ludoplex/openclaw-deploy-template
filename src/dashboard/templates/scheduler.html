{% extends "base.html" %}

{% block title %}Scheduler - SOP Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">‚è∞ SOP Scheduler</h1>
        <button onclick="document.getElementById('addModal').classList.remove('hidden')"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
            + Add Schedule
        </button>
    </div>

    <!-- Filters -->
    <div class="mb-6 flex gap-4">
        <select id="entityFilter" onchange="filterSchedules()" 
                class="px-3 py-2 border rounded-lg">
            <option value="">All Entities</option>
            <option value="mighty_house_inc">Mighty House Inc</option>
            <option value="dsaic">DSAIC</option>
            <option value="computer_store">Computer Store</option>
        </select>
        <select id="statusFilter" onchange="filterSchedules()"
                class="px-3 py-2 border rounded-lg">
            <option value="">All Status</option>
            <option value="enabled">Enabled</option>
            <option value="disabled">Disabled</option>
        </select>
    </div>

    <!-- Schedules Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">SOP</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entity</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Schedule</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Next Run</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Runs</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody id="schedulesTable" class="bg-white divide-y divide-gray-200">
                {% for schedule in schedules %}
                <tr class="schedule-row" 
                    data-entity="{{ schedule.entity }}" 
                    data-enabled="{{ 'enabled' if schedule.enabled else 'disabled' }}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="/sop/{{ schedule.entity }}/{{ schedule.sop_id }}" 
                           class="text-blue-600 hover:underline">
                            {{ schedule.sop_id }}
                        </a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 text-xs rounded-full 
                            {% if schedule.entity == 'mighty_house_inc' %}bg-blue-100 text-blue-800
                            {% elif schedule.entity == 'dsaic' %}bg-green-100 text-green-800
                            {% elif schedule.entity == 'computer_store' %}bg-purple-100 text-purple-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ schedule.entity | replace('_', ' ') | title }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                        {{ schedule.schedule_type }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap font-mono text-sm">
                        {{ schedule.expression }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {% if schedule.next_run %}
                            {{ schedule.next_run[:16] | replace('T', ' ') }}
                        {% else %}
                            <span class="text-gray-400">‚Äî</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        {{ schedule.run_count }}{% if schedule.max_runs %}/{{ schedule.max_runs }}{% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button hx-post="/api/scheduler/{{ schedule.id }}/toggle"
                                hx-swap="outerHTML"
                                hx-target="closest tr"
                                class="relative inline-flex h-6 w-11 items-center rounded-full transition
                                    {{ 'bg-green-500' if schedule.enabled else 'bg-gray-300' }}">
                            <span class="inline-block h-4 w-4 transform rounded-full bg-white transition
                                {{ 'translate-x-6' if schedule.enabled else 'translate-x-1' }}"></span>
                        </button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex gap-2">
                            <button hx-post="/api/scheduler/{{ schedule.id }}/run"
                                    hx-target="#runResult"
                                    hx-swap="innerHTML"
                                    class="text-green-600 hover:text-green-800" title="Run Now">
                                ‚ñ∂Ô∏è
                            </button>
                            <button onclick="editSchedule('{{ schedule.id }}')"
                                    class="text-blue-600 hover:text-blue-800" title="Edit">
                                ‚úèÔ∏è
                            </button>
                            <button hx-delete="/api/scheduler/{{ schedule.id }}"
                                    hx-confirm="Delete this schedule?"
                                    hx-target="closest tr"
                                    hx-swap="outerHTML"
                                    class="text-red-600 hover:text-red-800" title="Delete">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                        No schedules configured. Click "Add Schedule" to create one.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Run Result -->
    <div id="runResult" class="mt-4"></div>
</div>

<!-- Add Schedule Modal -->
<div id="addModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
        <div class="flex justify-between items-center px-6 py-4 border-b">
            <h2 class="text-xl font-semibold">Add Schedule</h2>
            <button onclick="document.getElementById('addModal').classList.add('hidden')"
                    class="text-gray-500 hover:text-gray-700">&times;</button>
        </div>
        <form hx-post="/api/scheduler" hx-target="#schedulesTable" hx-swap="beforeend"
              hx-on::after-request="document.getElementById('addModal').classList.add('hidden')"
              class="p-6 space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Entity</label>
                    <select name="entity" required class="w-full px-3 py-2 border rounded-lg">
                        <option value="mighty_house_inc">Mighty House Inc</option>
                        <option value="dsaic">DSAIC</option>
                        <option value="computer_store">Computer Store</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">SOP</label>
                    <select name="sop_id" required class="w-full px-3 py-2 border rounded-lg">
                        {% for entity, sops in all_sops.items() %}
                        <optgroup label="{{ entity | replace('_', ' ') | title }}">
                            {% for sop in sops %}
                            <option value="{{ sop.sop_id }}">{{ sop.name }}</option>
                            {% endfor %}
                        </optgroup>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Schedule Type</label>
                    <select name="schedule_type" required class="w-full px-3 py-2 border rounded-lg">
                        <option value="cron">Cron Expression</option>
                        <option value="interval">Interval</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="once">One-time</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Expression</label>
                    <input type="text" name="expression" required
                           placeholder="0 9 * * * or 4h or 2026-02-02T10:00"
                           class="w-full px-3 py-2 border rounded-lg">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Max Runs (optional)</label>
                <input type="number" name="max_runs" min="1"
                       placeholder="Leave empty for unlimited"
                       class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div class="flex justify-end gap-3 pt-4">
                <button type="button" 
                        onclick="document.getElementById('addModal').classList.add('hidden')"
                        class="px-4 py-2 border rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Create Schedule
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function filterSchedules() {
    const entity = document.getElementById('entityFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    document.querySelectorAll('.schedule-row').forEach(row => {
        const matchEntity = !entity || row.dataset.entity === entity;
        const matchStatus = !status || row.dataset.enabled === status;
        row.style.display = (matchEntity && matchStatus) ? '' : 'none';
    });
}

function editSchedule(id) {
    // Could open edit modal - for now redirect
    window.location.href = `/scheduler/${id}/edit`;
}
</script>
{% endblock %}
