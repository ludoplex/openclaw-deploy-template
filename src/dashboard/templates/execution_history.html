{% extends "base.html" %}

{% block title %}Execution History | SOP Dashboard{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="flex-1 min-w-0">
            <h1 class="text-2xl font-bold leading-7 text-white sm:text-3xl">
                üìú Execution History
            </h1>
            <p class="mt-1 text-gray-400">View past SOP executions and their results</p>
        </div>
        <div class="mt-4 flex md:mt-0 md:ml-4 space-x-3">
            <button 
                hx-get="/api/history/refresh"
                hx-target="#history-table"
                hx-swap="innerHTML"
                class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                üîÑ Refresh
            </button>
            <button class="bg-red-700 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium">
                üóëÔ∏è Clear History
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="flex flex-wrap gap-3">
        <select class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-sm text-gray-300">
            <option value="">All Entities</option>
            <option value="mighty_house_inc">MHI</option>
            <option value="dsaic">DSAIC</option>
            <option value="computer_store">Computer Store</option>
        </select>
        <select class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-sm text-gray-300">
            <option value="">All Statuses</option>
            <option value="success">Success</option>
            <option value="failed">Failed</option>
            <option value="partial">Partial</option>
        </select>
        <input type="date" class="bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-sm text-gray-300">
    </div>

    <!-- History Table -->
    <div id="history-table" class="bg-gray-800 rounded-lg shadow-xl border border-gray-700 overflow-hidden">
        <table class="min-w-full divide-y divide-gray-700">
            <thead class="bg-gray-750">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Time</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">SOP</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Entity</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Steps</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase">Duration</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-400 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                {% for execution in executions %}
                <tr class="hover:bg-gray-750 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {{ execution.started_at }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-white">{{ execution.sop_name }}</div>
                        <div class="text-xs text-gray-400">{{ execution.sop_id }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if execution.entity == 'mighty_house_inc' %}
                        <span class="px-2 py-1 text-xs rounded-full bg-blue-900 text-blue-300">MHI</span>
                        {% elif execution.entity == 'dsaic' %}
                        <span class="px-2 py-1 text-xs rounded-full bg-purple-900 text-purple-300">DSAIC</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs rounded-full bg-green-900 text-green-300">CS</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if execution.success %}
                        <span class="px-2 py-1 text-xs rounded-full bg-green-900 text-green-300">‚úì Success</span>
                        {% else %}
                        <span class="px-2 py-1 text-xs rounded-full bg-red-900 text-red-300">‚úó Failed</span>
                        {% endif %}
                        {% if execution.dry_run %}
                        <span class="ml-1 px-2 py-1 text-xs rounded-full bg-yellow-900 text-yellow-300">Dry-Run</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="text-green-400">{{ execution.steps_passed }}</span>
                        <span class="text-gray-500">/</span>
                        <span class="text-gray-300">{{ execution.steps_total }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                        {{ execution.duration_ms }}ms
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm">
                        <button 
                            hx-get="/api/history/{{ execution.id }}/details"
                            hx-target="#details-modal"
                            hx-swap="innerHTML"
                            class="text-blue-400 hover:text-blue-300">
                            View Details
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-gray-400">
                        <div class="text-4xl mb-2">üì≠</div>
                        <p>No execution history yet</p>
                        <p class="text-sm mt-1">Run an SOP to see it here</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="flex justify-center space-x-2">
        {% for page in range(1, total_pages + 1) %}
        <button class="px-3 py-1 rounded {% if page == current_page %}bg-blue-600 text-white{% else %}bg-gray-700 text-gray-300 hover:bg-gray-600{% endif %}">
            {{ page }}
        </button>
        {% endfor %}
    </div>
    {% endif %}
</div>

<!-- Details Modal -->
<div id="details-modal"></div>
{% endblock %}
