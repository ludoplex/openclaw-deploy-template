{% extends "base.html" %}

{% block title %}Media Pipeline - SOP Dashboard{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-white">üé® Media Generation Pipeline</h1>
            <p class="text-gray-400 mt-1">Create Canva images and Sora 2 videos from marketing prompts</p>
        </div>
        <div class="flex gap-3">
            <button onclick="document.getElementById('briefModal').classList.remove('hidden')"
                    class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium">
                ‚ú® Generate Brief
            </button>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <p class="text-gray-400 text-sm">Total Prompts</p>
            <p class="text-2xl font-bold text-white">
                {{ library_stats.total_prompts.canva + library_stats.total_prompts.sora2 }}
            </p>
            <p class="text-xs text-gray-500 mt-1">
                {{ library_stats.total_prompts.canva }} Canva, {{ library_stats.total_prompts.sora2 }} Sora 2
            </p>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <p class="text-gray-400 text-sm">Services Covered</p>
            <p class="text-2xl font-bold text-blue-400">{{ library_stats.total_services }}</p>
            <p class="text-xs text-gray-500 mt-1">Across {{ library_stats.entities|length }} entities</p>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <p class="text-gray-400 text-sm">Pending Approvals</p>
            <p class="text-2xl font-bold text-yellow-400">{{ pending_approvals|length }}</p>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
            <p class="text-gray-400 text-sm">Total Requests</p>
            <p class="text-2xl font-bold text-green-400">{{ pipeline_stats.total_requests }}</p>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Prompt Browser (Left Column) -->
        <div class="lg:col-span-2 space-y-4">
            <div class="bg-gray-800 rounded-lg border border-gray-700">
                <div class="p-4 border-b border-gray-700">
                    <h2 class="text-xl font-bold text-white">üìö Prompt Library</h2>
                    
                    <!-- Filters -->
                    <div class="mt-3 flex flex-wrap gap-3">
                        <select id="filterEntity" onchange="filterPrompts()" 
                                class="bg-gray-700 border border-gray-600 text-white rounded px-3 py-2 text-sm">
                            <option value="">All Entities</option>
                            {% for entity in entities %}
                            <option value="{{ entity }}">{{ entity.replace('_', ' ').title() }}</option>
                            {% endfor %}
                        </select>
                        
                        <select id="filterCategory" onchange="filterPrompts()"
                                class="bg-gray-700 border border-gray-600 text-white rounded px-3 py-2 text-sm">
                            <option value="">All Categories</option>
                            {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                        
                        <select id="filterType" onchange="filterPrompts()"
                                class="bg-gray-700 border border-gray-600 text-white rounded px-3 py-2 text-sm">
                            <option value="">All Types</option>
                            <option value="canva">üñºÔ∏è Canva</option>
                            <option value="sora2">üé¨ Sora 2</option>
                        </select>
                        
                        <input type="text" id="searchPrompts" placeholder="Search..." onkeyup="searchPrompts()"
                               class="bg-gray-700 border border-gray-600 text-white rounded px-3 py-2 text-sm flex-1 min-w-[200px]">
                    </div>
                </div>
                
                <!-- Prompt List -->
                <div id="promptList" class="max-h-[600px] overflow-y-auto">
                    <div class="p-4 text-gray-400 text-center">
                        <p>Loading prompts...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="space-y-4">
            
            <!-- Create Request Panel -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-bold text-white mb-3">‚ûï Create Request</h3>
                <p class="text-sm text-gray-400 mb-4">Select a prompt from the library to create a media request</p>
                
                <div id="selectedPrompt" class="hidden">
                    <div class="bg-gray-700 rounded p-3 mb-4">
                        <p class="text-sm text-gray-300" id="selectedPromptText"></p>
                    </div>
                    
                    <form id="createRequestForm" class="space-y-3">
                        <input type="hidden" id="reqEntity" name="entity">
                        <input type="hidden" id="reqServiceId" name="service_id">
                        <input type="hidden" id="reqVariant" name="variant">
                        <input type="hidden" id="reqMediaType" name="media_type">
                        
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Output Format</label>
                            <select id="reqFormat" name="output_format" 
                                    class="w-full bg-gray-700 border border-gray-600 text-white rounded px-3 py-2">
                                <!-- Populated by JS based on media type -->
                            </select>
                        </div>
                        
                        <div id="durationField" class="hidden">
                            <label class="block text-sm text-gray-400 mb-1">Duration (seconds)</label>
                            <input type="number" name="duration" value="15" min="5" max="60"
                                   class="w-full bg-gray-700 border border-gray-600 text-white rounded px-3 py-2">
                        </div>
                        
                        <div>
                            <label class="block text-sm text-gray-400 mb-1">Custom Prompt (optional)</label>
                            <textarea name="custom_prompt" rows="3" placeholder="Edit the prompt if needed..."
                                      class="w-full bg-gray-700 border border-gray-600 text-white rounded px-3 py-2 text-sm"></textarea>
                        </div>
                        
                        <button type="submit" 
                                class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-medium">
                            Create Request
                        </button>
                    </form>
                </div>
                
                <div id="noPromptSelected" class="text-center py-8">
                    <p class="text-gray-500">üëà Select a prompt from the library</p>
                </div>
                
                <div id="requestResult" class="mt-4"></div>
            </div>

            <!-- Pending Approvals -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-bold text-white mb-3">‚è≥ Pending Approvals</h3>
                
                {% if pending_approvals %}
                <div class="space-y-2">
                    {% for req in pending_approvals %}
                    <div class="bg-gray-700 rounded p-3 text-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-white font-medium">{{ req.service_name }}</p>
                                <p class="text-gray-400 text-xs">
                                    {{ req.media_type }} | {{ req.entity.replace('_', ' ').title() }}
                                </p>
                            </div>
                            <div class="flex gap-1">
                                <button hx-post="/api/media/request/{{ req.id }}/approve"
                                        hx-swap="outerHTML"
                                        class="px-2 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs">
                                    ‚úì
                                </button>
                                <button hx-post="/api/media/request/{{ req.id }}/reject"
                                        hx-swap="outerHTML"
                                        class="px-2 py-1 bg-red-600 hover:bg-red-700 text-white rounded text-xs">
                                    ‚úó
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm text-center py-4">No pending approvals</p>
                {% endif %}
            </div>

            <!-- Recent Requests -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
                <h3 class="text-lg font-bold text-white mb-3">üïê Recent Requests</h3>
                
                {% if recent_requests %}
                <div class="space-y-2">
                    {% for req in recent_requests[:5] %}
                    <div class="bg-gray-700 rounded p-2 text-sm flex justify-between items-center">
                        <div>
                            <p class="text-gray-300">{{ req.service_name[:25] }}{% if req.service_name|length > 25 %}...{% endif %}</p>
                            <p class="text-xs text-gray-500">{{ req.created_at[:16] }}</p>
                        </div>
                        <span class="px-2 py-1 rounded text-xs
                            {% if req.status == 'approved' %}bg-green-900 text-green-300
                            {% elif req.status == 'pending_approval' %}bg-yellow-900 text-yellow-300
                            {% elif req.status == 'rejected' %}bg-red-900 text-red-300
                            {% else %}bg-gray-600 text-gray-300{% endif %}">
                            {{ req.status.replace('_', ' ').title() }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-gray-500 text-sm text-center py-4">No requests yet</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Brief Generation Modal -->
<div id="briefModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 border border-gray-700">
        <h3 class="text-xl font-bold text-white mb-4">‚ú® Generate Content Brief</h3>
        <form hx-post="/api/media/brief" hx-target="#briefResult" hx-swap="innerHTML">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Entity</label>
                    <select name="entity" class="w-full bg-gray-700 border border-gray-600 text-white rounded px-3 py-2">
                        {% for entity in entities %}
                        <option value="{{ entity }}">{{ entity.replace('_', ' ').title() }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Category (optional)</label>
                    <select name="category" class="w-full bg-gray-700 border border-gray-600 text-white rounded px-3 py-2">
                        <option value="">All Categories</option>
                        {% for cat in categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">Number of Recommendations</label>
                    <input type="number" name="count" value="5" min="1" max="10"
                           class="w-full bg-gray-700 border border-gray-600 text-white rounded px-3 py-2">
                </div>
            </div>
            <div class="mt-6 flex gap-3">
                <button type="submit" class="flex-1 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded font-medium">
                    Generate
                </button>
                <button type="button" onclick="document.getElementById('briefModal').classList.add('hidden')"
                        class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">
                    Cancel
                </button>
            </div>
        </form>
        <div id="briefResult" class="mt-4"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const imageFormats = [
    { value: '1080x1080', label: 'Instagram Square (1080x1080)' },
    { value: '1200x628', label: 'Facebook Post (1200x628)' },
    { value: '1080x1920', label: 'Instagram Story (1080x1920)' },
    { value: '1200x675', label: 'Twitter Post (1200x675)' },
];

const videoFormats = [
    { value: '9:16', label: 'TikTok/Reels (9:16)' },
    { value: '16:9', label: 'YouTube (16:9)' },
    { value: '1:1', label: 'Square (1:1)' },
];

// Load prompts on page load
document.addEventListener('DOMContentLoaded', () => {
    loadPrompts();
});

async function loadPrompts(filters = {}) {
    const params = new URLSearchParams(filters);
    const response = await fetch(`/api/media/prompts?${params}`);
    const data = await response.json();
    renderPromptList(data.prompts);
}

function renderPromptList(prompts) {
    const container = document.getElementById('promptList');
    
    if (!prompts.length) {
        container.innerHTML = '<div class="p-4 text-gray-400 text-center">No prompts found</div>';
        return;
    }
    
    let html = '<div class="divide-y divide-gray-700">';
    for (const p of prompts) {
        const icon = p.media_type === 'canva' ? 'üñºÔ∏è' : 'üé¨';
        const bgColor = p.media_type === 'canva' ? 'hover:bg-blue-900/20' : 'hover:bg-purple-900/20';
        
        html += `
            <div class="p-3 cursor-pointer ${bgColor} transition-colors" 
                 onclick="selectPrompt('${p.entity}', ${p.service_id}, ${p.variant}, '${p.media_type}')">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <p class="text-white font-medium">${icon} ${p.service_name}</p>
                        <p class="text-xs text-gray-500">${p.category} | ${p.entity.replace('_', ' ')} | Variant ${p.variant}</p>
                        <p class="text-sm text-gray-400 mt-1">${p.prompt_preview}</p>
                    </div>
                    <span class="px-2 py-1 rounded text-xs ${p.media_type === 'canva' ? 'bg-blue-900 text-blue-300' : 'bg-purple-900 text-purple-300'}">
                        ${p.price}
                    </span>
                </div>
            </div>
        `;
    }
    html += '</div>';
    container.innerHTML = html;
}

async function selectPrompt(entity, serviceId, variant, mediaType) {
    // Fetch full prompt details
    const response = await fetch(`/api/media/prompts/${entity}/${serviceId}`);
    const service = await response.json();
    
    const prompts = mediaType === 'canva' ? service.canva_prompts : service.sora2_prompts;
    const prompt = prompts[variant - 1];
    
    // Update form
    document.getElementById('reqEntity').value = entity;
    document.getElementById('reqServiceId').value = serviceId;
    document.getElementById('reqVariant').value = variant;
    document.getElementById('reqMediaType').value = mediaType;
    document.getElementById('selectedPromptText').textContent = prompt;
    
    // Update format options
    const formatSelect = document.getElementById('reqFormat');
    const formats = mediaType === 'canva' ? imageFormats : videoFormats;
    formatSelect.innerHTML = formats.map(f => `<option value="${f.value}">${f.label}</option>`).join('');
    
    // Show/hide duration field
    document.getElementById('durationField').classList.toggle('hidden', mediaType === 'canva');
    
    // Show panel
    document.getElementById('selectedPrompt').classList.remove('hidden');
    document.getElementById('noPromptSelected').classList.add('hidden');
}

function filterPrompts() {
    const entity = document.getElementById('filterEntity').value;
    const category = document.getElementById('filterCategory').value;
    const mediaType = document.getElementById('filterType').value;
    
    loadPrompts({ entity, category, media_type: mediaType });
}

let searchTimeout;
function searchPrompts() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const query = document.getElementById('searchPrompts').value;
        if (query.length > 2) {
            loadPrompts({ search: query });
        } else if (query.length === 0) {
            filterPrompts();
        }
    }, 300);
}

// Form submission
document.getElementById('createRequestForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const mediaType = formData.get('media_type');
    
    const endpoint = mediaType === 'canva' ? '/api/media/request/image' : '/api/media/request/video';
    
    const response = await fetch(endpoint, {
        method: 'POST',
        body: formData
    });
    
    const html = await response.text();
    document.getElementById('requestResult').innerHTML = html;
});
</script>
{% endblock %}
