name: Build & Test
on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

env:
  COSMOCC_VERSION: "3.9.7"

jobs:
  build:
    strategy:
      matrix:
        include:
          - { os: ubuntu-latest, cc: gcc }
          - { os: ubuntu-latest, cc: clang }
          - { os: macos-latest, cc: clang }
    runs-on: {{ "${{ matrix.os }}" }}
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libsqlite3-dev cppcheck valgrind
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install sqlite3 cppcheck
      - name: Build native
        run: make native
        env:
          CC_NATIVE: {{ "${{ matrix.cc }}" }}
      - name: Run tests
        run: make test
        env:
          CC_NATIVE: {{ "${{ matrix.cc }}" }}
      - uses: actions/upload-artifact@v4
        with:
          name: {{ "{{ cookiecutter.project_slug }}-${{ matrix.os }}-${{ matrix.cc }}" }}
          path: build/{{ "{{ cookiecutter.project_slug }}" }}
          retention-days: 14

  cosmo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download cosmocc
        run: |
          mkdir -p cosmocc
          curl -L https://cosmo.zip/pub/cosmocc/cosmocc-${COSMOCC_VERSION}.zip -o cosmocc.zip
          unzip -q cosmocc.zip -d cosmocc
          echo "$PWD/cosmocc/bin" >> $GITHUB_PATH
      - name: Fetch SQLite amalgamation
        run: make vendor/sqlite/sqlite3.c || true
      - name: Build APE binary
        run: CC=cosmocc make cosmo
      - uses: actions/upload-artifact@v4
        with:
          name: {{ "{{ cookiecutter.project_slug }}" }}-ape
          path: dist/{{ "{{ cookiecutter.project_slug }}" }}.com
          retention-days: 30

  analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y libsqlite3-dev cppcheck clang-tools
      - name: cppcheck
        run: make cppcheck

  sanitizers:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: sudo apt-get update && sudo apt-get install -y libsqlite3-dev
      - name: ASAN + UBSAN tests
        run: make test-san
        env:
          CC_NATIVE: clang
      - name: Valgrind
        run: |
          sudo apt-get install -y valgrind
          make native
          valgrind --error-exitcode=1 --leak-check=full build/{{ "{{ cookiecutter.project_slug }}" }} || true
